version: "3.8"

services:
  app:
    build:
      context: .
      dockerfile: demo/Dockerfile
    image: honeycomb-app:latest
    container_name: honeycomb-forensic-app
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_NEO4J_URI=bolt://neo4j:7687
      - SPRING_NEO4J_AUTHENTICATION_USERNAME=neo4j
      - SPRING_NEO4J_AUTHENTICATION_PASSWORD=password
      - SPRING_DATA_NEO4J_DATABASE=neo4j
      - LOGGING_LEVEL_COM_EXAMPLE=INFO
    depends_on:
      neo4j:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - honeycomb-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/algorithms/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  neo4j:
    image: neo4j:5.15-alpine
    container_name: honeycomb-neo4j
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS='["graph-data-science", "apoc"]'
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_graph_sampling_enabled=true
    volumes:
      - neo4j-data:/var/lib/neo4j/data
      - neo4j-logs:/var/lib/neo4j/logs
      - neo4j-import:/var/lib/neo4j/import
      - neo4j-export:/var/lib/neo4j/export
    ports:
      - "7474:7474"
      - "7687:7687"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7474/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 10s
    networks:
      - honeycomb-net

volumes:
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  neo4j-import:
    driver: local
  neo4j-export:
    driver: local

networks:
  honeycomb-net:
    driver: bridge
FROM maven:3.9-eclipse-temurin-17 AS builder

WORKDIR /build

# Copiar archivos de configuración
COPY demo/pom.xml .

# Descargar dependencias
RUN mvn dependency:resolve

# Copiar código fuente
COPY demo/src ./src

# Compilar
RUN mvn clean package -DskipTests

# Etapa final
FROM eclipse-temurin:17-jre-alpine

WORKDIR /app

# Copiar JAR desde etapa de build
COPY --from=builder /build/target/*.jar app.jar

# Exponer puerto
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/api/algorithms/health || exit 1

# Ejecutar aplicación
ENTRYPOINT ["java", "-jar", "app.jar"]

